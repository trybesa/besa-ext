(()=>{let e=null;async function t(){console.log("Handling content update");try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e||!e.url)return void console.log("No active tab found");const t=await chrome.storage.local.get(null);console.log("Current storage:",t),await r()}catch(e){console.error("Error handling content update:",e)}}async function n(e){try{const t=document.querySelectorAll('input[type="checkbox"]:checked');let n="";for(const e of t){const t=e.getAttribute("data-url"),o=await chrome.storage.local.get(`page_${t}`);o[`page_${t}`]&&(n+=`${o[`page_${t}`].content}\n\n`)}if(!n){const e=await async function(){try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e||!e.url)return console.log("No active tab or URL found"),{content:"",title:"",success:!1};if(e.url.startsWith("chrome://")||e.url.startsWith("chrome-extension://"))return console.log("Unsupported URL type"),{content:"",title:"",success:!1};const t=await chrome.storage.local.get(`page_${e.url}`);if(t[`page_${e.url}`]){const n=t[`page_${e.url}`];return{content:n.content,title:n.title,success:!0}}return new Promise((t=>{chrome.tabs.sendMessage(e.id,{action:"getPageContent"},(n=>{if(chrome.runtime.lastError||!n)return console.error("Error:",chrome.runtime.lastError),void t({content:"",title:"",success:!1});n.success&&chrome.storage.local.set({[`page_${e.url}`]:{content:n.content,title:n.title,url:e.url,timestamp:Date.now()}}),t(n)}))}))}catch(e){return console.error("Scraping error:",e),{content:"",title:"",success:!1}}}();n=e.success?e.content:"no data"}return new Promise(((t,o)=>{chrome.runtime.sendMessage({action:"getExplanation",selectedText:n,query:e},(e=>{chrome.runtime.lastError?o(new Error(chrome.runtime.lastError.message)):e&&e.success?t(e.data.answer):o(new Error(e?.error||"Failed to get explanation"))}))}))}catch(e){throw console.error("OpenAI API Error:",e),e}}function o(e,t=!1){const n=document.getElementById("messages");if(!n)return;const o=document.createElement("div");o.className="message "+(t?"user-message":"bot-message");const r=document.createElement("div");r.textContent=e,o.appendChild(r),n.appendChild(o),n.scrollTop=n.scrollHeight}async function r(){const e=document.getElementById("stored-pages-container");if(e)try{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});console.log("Current tab:",t);const n=await chrome.storage.local.get(null);console.log("All stored data:",n),e.innerHTML="";const o=Object.entries(n).filter((([e,t])=>e.startsWith("page_")&&t.content&&t.title)).sort((([,e],[,t])=>t.timestamp-e.timestamp));if(console.log("Filtered pages:",o),0===o.length){console.log("No stored pages, fetching current page...");const t=await async function(){try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});return e&&e.url?e.url.startsWith("chrome://")||e.url.startsWith("chrome-extension://")?(console.log("Unsupported URL type"),null):new Promise((t=>{chrome.tabs.sendMessage(e.id,{action:"getPageContent"},(e=>{if(chrome.runtime.lastError)return console.error("Error:",chrome.runtime.lastError),void t(null);console.log("Got page content response:",e),t(e)}))})):(console.log("No active tab or URL found"),null)}catch(e){return console.error("Error getting tab content:",e),null}}();if(t&&t.success)return console.log("Got current page content:",t),await chrome.storage.local.set({[`page_${t.url}`]:{content:t.content,title:t.title,url:t.url,timestamp:Date.now()}}),void await r();const n=document.createElement("div");return n.className="no-pages-message",n.textContent="No stored pages yet",void e.appendChild(n)}for(const[n,r]of o){const o=document.createElement("div");o.className="checkbox-container";const c=document.createElement("input");c.type="checkbox",c.id=`checkbox-${n}`,c.setAttribute("data-url",r.url),t&&t.url===r.url&&(c.checked=!0);const a=document.createElement("label");a.htmlFor=c.id,a.title=r.url,a.textContent=r.title||"Untitled Page",o.appendChild(c),o.appendChild(a),e.appendChild(o)}}catch(t){console.error("Error updating checkboxes:",t);const n=document.createElement("div");n.className="error-message",n.textContent="Error loading stored pages",e.appendChild(n)}else console.error("Stored pages container not found")}document.addEventListener("DOMContentLoaded",(async()=>{e=chrome.runtime.connect({name:"popup"}),console.log("Connected to background script");const r=document.getElementById("warning-banner");if(r)if((await chrome.storage.local.get("warningBannerDismissed")).warningBannerDismissed)r.style.display="none";else{const e=document.createElement("button");e.innerHTML="Ã—",e.className="warning-dismiss",e.title="Dismiss",e.onclick=async()=>{r.style.display="none",await chrome.storage.local.set({warningBannerDismissed:!0})},r.appendChild(e)}const c=document.getElementById("messages"),a=document.getElementById("user-input"),s=document.getElementById("send-button"),l=document.getElementById("summarize-button"),i=document.getElementById("stored-pages-container"),d=document.getElementById("new-chat-button");c&&a&&s&&l?(i&&(await t(),o("Start a new conversation!")),chrome.tabs.onActivated.addListener((async e=>{console.log("Tab changed, updating content..."),await t()})),chrome.tabs.onUpdated.addListener((async(e,n,o)=>{"complete"===n.status&&(console.log("Tab updated, updating content..."),await t())})),l&&l.addEventListener("click",(async()=>{const e="summarize the documentation";o(e,!0);try{o(await n(e))}catch(e){o(`Error: ${e.message}`)}})),s&&a&&(s.addEventListener("click",(async()=>{const e=a.value.trim();if(e){o(e,!0),a.disabled=!0,s.disabled=!0;try{o(await n(e))}catch(e){o(`Error: ${e.message}`)}finally{a.disabled=!1,s.disabled=!1,a.value=""}}})),a.addEventListener("keypress",(e=>{"Enter"===e.key&&s.click()}))),d&&c&&d.addEventListener("click",(()=>{c.innerHTML="",a&&(a.value=""),o("Start a new conversation!")}))):console.error("Required elements not found")})),window.addEventListener("unload",(()=>{e&&e.disconnect()})),chrome.runtime.onMessage.addListener(((e,n,o)=>{console.log("Received message in popup:",e),"contentScraped"===e.action&&(console.log("Content scraped, updating UI..."),t())}))})();